# Архитектура - VideoGymnast

Цель документа — описать архитектурные решения, используемые в проекте, и объяснить, как модули взаимодействуют между собой.

## Компоненты

1. MessageBus (core/messagebus.py)

   - Централизованный маршрутизатор сообщений между сервисами.
   - Поддерживает два типа сообщений:
     - Event — асинхронные уведомления (обработка идёт через очередь и отдельный поточный диспетчер).
     - Command — синхронные команды (обрабатываются немедленно и возвращают результат).
   - Позволяет регистрировать зависимости, которые будут автоматически инжектированы в обработчики (через параметры функции, кроме первого).

2. Services

   - MainService
     - Координатор пайплайна: сканирует папку input, формирует параметры и запускает команды перекодирования.
   - TranscoderService
     - Обрабатывает команду OnTranscoderRun: строит команду ffmpeg, запускает её и публикует события прогресса и завершения.
   - RichService
     - Отвечает за вывод в консоль: панели, прогрессбары, сообщения об ошибках.

3. Components
   - get_media_info — извлечение информации о медиа (pymediainfo).
   - build_media_params — логика выбора разрешения и битрейта.
   - app_init — подготовка окружения (директории, очистка временных файлов).
   - utils — утилиты для фс и форматирования.

## Поток данных (pipeline)

1. MainService.scan_input -> получает список файлов.
2. Для каждого файла:
   - get_media_info считывает характеристики (ширина, высота, fps, битрейт).
   - build_media_params вычисляет целевое разрешение/битрейт/аудио.
   - MainService публикует OnFileDataProcessed и команду OnTranscoderRun.
3. TranscoderService запускает ffmpeg:
   - Используется ffmpeg-progress-yield для получения прогресса в реальном времени.
   - По каждому обновлению публикуется OnTranscodingProgressEvent.
   - По завершении публикуется OnTranscodingCompleted с флагом ok и сообщением.
4. RichService подписан на события и обновляет отображение.

## Дизайн MessageBus

- Простая реализация Pub/Sub + команды.
- Поддерживает валидацию обработчиков: запрещает \*args и \*\*kwargs, проверяет наличие зависимостей.
- Потокобезопасный: события складываются в очередь и обрабатываются отдельным потоком.
- Команды выполняются синхронно (т.е. вызывающий код ждёт результата).

## Расширение и разработка

- Добавление нового сервиса:
  - Создайте модуль в `src/services/your_service/`.
  - Подпишитесь на события или команды через `bus.subscribe_event` / `bus.subscribe_command`.
  - Регистрация сервиса в `src/main.py` (создать экземпляр с `bus`).
- Добавление нового обработчика ffmpeg:
  - Измените `services/transcoder/compile_cmd` — там формируется список аргументов.
- Поддержка новых контейнеров/расширений:
  - `core/config.py` содержит набор расширений `VIDEO_EXTS`.
- Лёгкая модификация политик битрейта / разрешения:
  - `components/build_media_params.py` — логика выбора разрешения и расчёта BPP.

## Примечания по надёжности

- Проверки ошибок при чтении метаданных: если видео/аудио-трек не найден — выбрасывается исключение, которое переводится в событие OnAppException.
- Finalize logic (TranscoderService.finalize_output): защищает от ухудшения качества (вес итогового файла больше исходного).
- Очистка временных файлов и проверка наличия директории выполняется в app_init.
